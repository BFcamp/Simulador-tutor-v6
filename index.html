<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Examen Oral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // NUEVO: Configurar el worker para PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* Un gris-verde muy claro */
        }
        /* Estilos para el spinner de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        /* Spinner más pequeño para respuestas */
        .answer-loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        /* NUEVO: Spinner para "Generar Más" */
        .sub-question-loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 10px 0;
            display: none; /* Oculto por defecto */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para pestañas */
        .tab-button {
            transition: all 0.2s ease-in-out;
            border-bottom-width: 3px;
            border-color: transparent;
        }
        .tab-button.active {
            border-color: #2563eb; /* blue-600 */
            color: #1d4ed8; /* blue-700 */
        }
        /* Ocultar paneles de pestañas inactivas */
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        /* Estilos para el modal de error */
        #error-modal {
            transition: opacity 0.3s ease;
        }
        /* Estilos para la sección de respuestas */
        .answer-text {
            font-size: 0.9rem;
            color: #1f2937; /* gray-800 */
            margin-top: 10px;
            border-radius: 4px;
            white-space: pre-wrap; /* Mantiene saltos de línea y espacios */
        }
        /* NUEVO: Estilos para respuesta editable vs. no editable */
        .answer-text[contenteditable="false"] {
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid transparent;
            border-left: 4px solid #2563eb; /* blue-600 */
            padding: 10px 14px;
        }
        .answer-text[contenteditable="true"] {
            background-color: #ffffff;
            border: 1px solid #93c5fd; /* blue-300 */
            box-shadow: 0 0 0 2px #dbeafe; /* blue-100 ring */
            outline: none;
            padding: 10px 14px;
            cursor: text;
        }
        .audio-player-container audio {
            width: 100%;
            height: 38px;
            margin-top: 8px;
        }
        /* Estilos para tarjetas de Q&A guardadas */
        .qa-card {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }
        .qa-card .question {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .qa-card .answer {
            font-size: 0.9rem;
            color: #4b5563;
            white-space: pre-wrap; /* Respeta saltos de línea */
            display: none; /* Oculta por defecto */
        }
        .qa-card .delete-qa-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: #fee2e2; /* red-100 */
            color: #dc2626; /* red-600 */
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10; /* Asegurar que esté por encima */
        }
        .qa-card .delete-qa-btn:hover {
            background-color: #fecaca; /* red-200 */
            transform: scale(1.1);
        }
        
        /* NUEVO: Botón de Editar */
        .qa-card .edit-qa-btn {
            position: absolute;
            top: 12px;
            right: 48px; /* Al lado del botón de borrar */
            background-color: #dbeafe; /* blue-100 */
            color: #2563eb; /* blue-600 */
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }
        .qa-card .edit-qa-btn:hover {
            background-color: #bfdbfe; /* blue-200 */
            transform: scale(1.1);
        }

        /* Nuevos estilos para SRS */
        .qa-card .show-answer-btn {
            width: 100%;
            padding: 10px;
            font-weight: 500;
            background-color: #f3f4f6;
            border-top: 1px solid #e5e7eb;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            color: #1f2937;
            transition: background-color 0.2s;
        }
        .qa-card .show-answer-btn:hover {
            background-color: #e5e7eb;
        }
        .qa-card .rating-controls {
            display: none; /* Oculto hasta mostrar respuesta */
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 16px;
            border-top: 1px solid #e5e7eb;
            padding-top: 16px;
        }
        .qa-card .rate-btn {
            padding: 8px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid;
        }
        .rate-btn[data-rating="hard"] {
            background-color: #fee2e2;
            border-color: #fca5a5;
            color: #b91c1c;
        }
        .rate-btn[data-rating="hard"]:hover { background-color: #fecaca; }
        
        .rate-btn[data-rating="good"] {
            background-color: #dbeafe;
            border-color: #93c5fd;
            color: #2563eb;
        }
        .rate-btn[data-rating="good"]:hover { background-color: #bfdbfe; }

        .rate-btn[data-rating="easy"] {
            background-color: #d1fae5;
            border-color: #a7f3d0;
            color: #065f46;
        }
        .rate-btn[data-rating="easy"]:hover { background-color: #a7f3d0; }

        /* NUEVO: Estilos para Temas Plegables (Pestaña Repasar) */
        .topic-toggle-btn {
            width: 100%;
            padding: 16px;
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            text-align: left;
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* gray-800 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
            margin-bottom: 8px; /* Separación entre botones de tema */
        }
        .topic-toggle-btn:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .topic-toggle-btn .toggle-icon {
            transition: transform 0.2s;
        }
        .topic-toggle-btn[aria-expanded="true"] .toggle-icon {
            transform: rotate(180deg);
        }
        .topic-questions-container {
            display: none; /* Oculto por defecto */
            padding-left: 16px;
            border-left: 2px solid #d1d5db; /* gray-300 */
            margin-bottom: 16px; /* Separación después de un grupo de preguntas */
            /* El espacio entre tarjetas se maneja por .qa-card { margin-bottom } */
        }
        .topic-questions-container.open {
            display: block;
        }

        /* NUEVO: Estilos para Barra de Progreso */
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px; /* rounded-full */
            height: 12px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #2563eb; /* blue-600 */
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }

        /* --- INICIO: NUEVOS Estilos para "Repaso por Unidades" (Acordeón) --- */
        .unit-group {
            margin-bottom: 16px;
        }
        .unit-toggle-btn {
            width: 100%;
            padding: 12px 0px;
            background-color: transparent;
            text-align: left;
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #111827; /* gray-900 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e5e7eb; /* gray-200 */
            margin-bottom: 16px;
        }
        .unit-toggle-btn .toggle-icon { transition: transform 0.2s; }
        .unit-toggle-btn[aria-expanded="true"] .toggle-icon { transform: rotate(180deg); }
        .unit-topics-container {
            display: none;
            padding-left: 16px;
            border-left: 2px solid #d1d5db; /* gray-300 */
        }
        .unit-topics-container.open { display: block; }
        
        /* Tema (reutiliza .topic-toggle-btn pero con clase JS .topic-toggle-btn-units) */
        .topic-toggle-btn-units {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
        }
        /* Contenedor de preguntas (reutiliza .topic-questions-container) */

        .qa-wrapper-units {
            margin-bottom: 12px;
        }
        
        /* Botón de Pregunta (reutiliza .qa-card para el borde y padding) */
        .question-toggle-btn-units {
            width: 100%;
            text-align: left;
            margin-bottom: 0; /* qa-wrapper se encarga del margen */
            transition: background-color 0.2s;
            position: relative; /* Para que el delete-qa-btn se posicione bien */
        }
        .question-toggle-btn-units:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        /* Contenido de la pregunta dentro del botón */
        .question-toggle-btn-units .question-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            /* El padding lo da .qa-card */
        }
        .question-toggle-btn-units .question-text {
            /* El estilo .question lo hereda de .qa-card */
            padding-right: 80px; /* MODIFICADO: Espacio para dos botones */
        }
        /* Botón de borrar dentro del botón de pregunta */
        .question-toggle-btn-units .delete-qa-btn {
            /* Posición absoluta heredada de .qa-card .delete-qa-btn */
            position: absolute; 
            top: 12px;
            right: 12px;
        }
        
        /* Contenedor de Respuesta */
        .answer-container-units {
            display: none; /* Oculto por defecto */
            /* Reutiliza estilos de .answer */
            font-size: 0.9rem;
            color: #4b5563;
            white-space: pre-wrap;
            /* Estilos de contenedor */
            padding: 12px 16px;
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb;
            border-top: 0;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        .answer-container-units.open {
            display: block;
        }
        
        /* Ajuste de bordes cuando la pregunta está abierta */
        .question-toggle-btn-units[aria-expanded="true"].qa-card {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            background-color: #f9fafb; /* gray-50 */
        }
        /* --- FIN: NUEVOS Estilos para "Repaso por Unidades" --- */

        /* NUEVO: Estilos para Hoja de Ruta */
        .roadmap-date-group {
            margin-bottom: 24px;
        }
        .roadmap-date-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1d4ed8; /* blue-700 */
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb; /* gray-200 */
            margin-bottom: 16px;
        }
        
        /* --- INICIO: NUEVOS Estilos para "Modo Estudio" --- */
        .mode-selection-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 768px) {
            .mode-selection-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        .mode-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 32px;
            border: 2px solid #e5e7eb; /* gray-200 */
            border-radius: 16px; /* rounded-2xl */
            transition: all 0.2s;
            cursor: pointer;
            text-align: center;
            background-color: #f9fafb; /* gray-50 */
        }
        .mode-card:hover {
            border-color: #2563eb; /* blue-600 */
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-4px);
        }
        .mode-card h3 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #111827; /* gray-900 */
            margin-top: 16px;
        }
        .mode-card p {
            font-size: 1rem; /* text-base */
            color: #4b5563; /* gray-600 */
            margin-top: 8px;
        }
        
        /* Estilos para el Navegador de Temas (Modo Estudio) */
        .syllabus-browser .unit-toggle-btn {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* gray-800 */
            margin-bottom: 8px;
            border-bottom-width: 1px;
        }
        .syllabus-browser .unit-topics-container {
            border-left: 2px solid #e5e7eb; /* gray-200 */
        }
        .syllabus-topic-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            font-size: 1rem;
            font-weight: 500;
            color: #374151; /* gray-700 */
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .syllabus-topic-btn:hover {
            background-color: #f4f7f6; /* nuestro bg-body */
        }
        .syllabus-topic-btn:not(:last-child) {
            margin-bottom: 4px;
        }
        
        /* Estilos para la Guía de Estudio (Modo Estudio) */
        .guide-summary {
            font-size: 1.125rem; /* text-lg */
            color: #374151; /* gray-700 */
            background-color: #f9fafb; /* gray-50 */
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #2563eb; /* blue-600 */
            margin-bottom: 24px;
        }
        .subtopic-block {
            background-color: white;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .subtopic-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .subtopic-header h4 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #111827; /* gray-900 */
        }
        .importance-badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem; /* text-xs */
            font-weight: 700; /* font-bold */
            text-transform: uppercase;
        }
        .importance-badge-alta { background-color: #fee2e2; color: #b91c1c; } /* red */
        .importance-badge-media { background-color: #fef3c7; color: #b45309; } /* amber */
        .importance-badge-baja { background-color: #dbeafe; color: #1e40af; } /* blue */
        
        .subtopic-body {
            padding: 16px;
        }
        .ai-justification {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* gray-600 */
            font-style: italic;
            margin-bottom: 16px;
        }
        .key-question-wrapper {
            /* Reusa el estilo de .question-item de renderExamUI */
            border-top: 1px solid #f3f4f6; /* gray-100 */
            padding-top: 16px;
        }
        .key-question-wrapper .question-text {
            font-weight: 600;
            color: #1f2937;
        }
        .generate-more-btn {
            margin-top: 16px;
            width: 100%;
            padding: 10px;
            font-weight: 500;
            background-color: #f3f4f6; /* gray-100 */
            border-top: 1px solid #e5e7eb;
            color: #1f2937;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        .generate-more-btn:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        .sub-question-container {
            padding: 0 16px 16px 16px; /* Padding para preguntas generadas */
        }
        /* --- FIN: NUEVOS Estilos para "Modo Estudio" --- */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="sync-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md w-full">
            <h3 class="text-2xl font-bold text-gray-800">Configurar Sincronización</h3>
            <p class="mt-3 text-base text-gray-600">
                Para sincronizar tus datos (materias, repasos) entre dispositivos, usa el mismo ID en todos ellos.
            </p>
            
            <div class="mt-6">
                <label for="sync-id-input" class="block text-sm font-medium text-gray-700">Pega tu ID de Sincronización existente:</label>
                <input type="text" id="sync-id-input" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <button id="save-sync-id" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none">
                    Guardar y Usar este ID
                </button>
            </div>
            
            <div class="mt-6 border-t pt-4">
                <p class="text-gray-600">O si este es tu primer dispositivo:</p>
                <button id="generate-sync-id" class="mt-3 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 focus:outline-none">
                    Generar un Nuevo ID
                </button>
            </div>
        </div>
    </div>
    <div class="max-w-6xl mx-auto p-4 sm:p-8">
        
        <header class="mb-8 bg-white shadow-lg rounded-xl p-6 sm:p-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">Simulador de Examen Oral</h1>
            <p class="text-lg text-gray-600">Entrena para tus exámenes con IA. Carga material, genera preguntas y guarda tus respuestas.</p>
            
            <div class="mt-6 border-t border-gray-200 pt-4">
                <label for="subject-selector" class="block text-base font-semibold text-gray-800 mb-2">Materia Actual:</label>
                <div class="flex flex-col sm:flex-row sm:space-x-2">
                    <select id="subject-selector" class="w-full sm:w-1/2 p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="">-- Cargar Materia --</option>
                        </select>
                    <input type="text" id="new-subject-name" placeholder="Nombre de nueva materia" class="mt-2 sm:mt-0 w-full sm:w-1/2 p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <button id="add-subject-btn" class="mt-2 sm:mt-0 px-5 py-2.5 bg-gray-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-all">
                        Crear
                    </button>
                </div>
            </div>
            <div id="sync-id-display" class="mt-3 text-xs text-gray-500" style="display: none;">
                User ID (Sincronización): <span id="user-id" class="font-mono bg-gray-100 p-1 rounded">Cargando...</span>
            </div>
        </header>

        <div class="mb-6">
            <nav class="flex space-x-4 sm:space-x-8 border-b border-gray-300" aria-label="Tabs">
                <button id="tab-material-btn" class="tab-button active whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Material
                </button>
                <button id="tab-simulador-btn" class="tab-button whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Estudiar y Simular
                </button>
                <button id="tab-ranking-btn" class="tab-button whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Ranking
                </button>
                <button id="tab-review-btn" class="tab-button whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Repasar (Hoy)
                </button>
                <button id="tab-units-btn" class="tab-button whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Repaso por Unidades
                </button>
                <button id="tab-roadmap-btn" class="tab-button whitespace-nowrap py-4 px-1 text-base sm:text-lg font-semibold text-gray-500">
                    Hoja de ruta
                </button>
            </nav>
        </div>

        <div class="bg-white shadow-xl rounded-xl p-6 sm:p-8">
            <div id="tab-material" class="tab-panel active space-y-6">
                <p class="text-base text-gray-600">
                    Pega tu material en las cajas de texto o sube un PDF. El contenido se guarda en la nube y es acumulativo.
                </p>
                
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label for="syllabus" class="block text-lg font-semibold text-gray-800">Plan de Estudio / Temario</label>
                        <button class="upload-pdf-btn px-4 py-2 bg-blue-100 text-blue-700 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors" data-target-textarea="syllabus">
                            Subir PDF
                        </button>
                    </div>
                    <input type="file" class="hidden-pdf-input" data-target-textarea="syllabus" accept=".pdf" style="display: none;">
                    <p class="pdf-status text-sm text-blue-600 mb-1" data-status-for="syllabus"></p>
                    <textarea id="syllabus" rows="8" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label for="theory" class="block text-lg font-semibold text-gray-800">Teoría / Apuntes / Casos Clínicos</label>
                        <button class="upload-pdf-btn px-4 py-2 bg-blue-100 text-blue-700 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors" data-target-textarea="theory">
                            Subir PDF
                        </button>
                    </div>
                    <input type="file" class="hidden-pdf-input" data-target-textarea="theory" accept=".pdf" style="display: none;">
                    <p class="pdf-status text-sm text-blue-600 mb-1" data-status-for="theory"></p>
                    <textarea id="theory" rows="12" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label for="experiences" class="block text-lg font-semibold text-gray-800">Experiencias de Exámenes Orales</label>
                        <button class="upload-pdf-btn px-4 py-2 bg-blue-100 text-blue-700 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors" data-target-textarea="experiences">
                            Subir PDF
                        </button>
                    </div>
                    <input type="file" class="hidden-pdf-input" data-target-textarea="experiences" accept=".pdf" style="display: none;">
                    <p class="pdf-status text-sm text-blue-600 mb-1" data-status-for="experiences"></p>
                    <textarea id="experiences" rows="8" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <button id="save-material" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-blue-600 text-white text-base font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                    Guardar Material
                </button>
                <div id="save-status" class="text-green-600 text-base mt-2"></div>
            </div>
            
            <div id="tab-simulador" class="tab-panel space-y-6">
                
                <div id="mode-selection-container" class="mode-selection-container">
                    <div id="study-mode-btn" class="mode-card">
                        <svg data-lucide="brain-circuit" class="w-16 h-16 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 0 0-1.2 20.01c.2 0 .2-.1.2-.2v-3.81a1.2 1.2 0 0 0-.21-.75c-.24-.26-1.14-.99-1.39-1.24a.2.2 0 0 1 0-.28c.2-.23.9-.9 1.14-1.14a1C10.66 14.24 10.66 14 10.5 14h-1.03a.2.2 0 0 1-.2-.28c.2-.23.9-.9 1.14-1.14a1C10.51 12.49 10.51 12.24 10.4 12h-1.03a.2.2 0 0 1-.2-.28c.2-.23.9-.9 1.14-1.14a1C10.51 10.49 10.51 10.24 10.4 10h-1.03a.2.2 0 0 1-.2-.28c.2-.23.9-.9 1.14-1.14a1C10.51 8.49 10.51 8.24 10.4 8H9.37a1 1 0 0 1-1-1c0-.49.16-.94.43-1.3A9.91 9.91 0 0 0 8 4.01a10 10 0 0 0-1.2 15.28c.2 0 .2-.1.2-.2v-3.81a1.2 1.2 0 0 0-.21-.75c-.24-.26-1.14-.99-1.39-1.24a.2.2 0 0 1 0-.28c.2-.23.9-.9 1.14-1.14a1C6.66 14.24 6.66 14 6.5 14H5.47a.2.2 0 0 1-.2-.28c.2-.23.9-.9 1.14-1.14a1C6.51 12.49 6.51 12.24 6.4 12H5.37a.2.2 0 0 1-.2-.28c.2-.23.9-.9 1.14-1.14a1C6.51 10.49 6.51 10.24 6.4 10H5.37a.2.2 0 0 1-.2-.28c.2-.23.9-.9 1.14-1.14a1C6.51 8.49 6.51 8.24 6.4 8H6.2a.2.2 0 0 1-.2-.2c0-1.1.9-2 2-2h.2a10 10 0 0 1 3.8 0h.2c1.1 0 2 .9 2 2a.2.2 0 0 1-.2.2H13.6c-.11.24-.11.49 0 .59s.9.9 1.14 1.14a.2.2 0 0 1-.2.28h-1.03c-.11.24-.11.49 0 .59s.9.9 1.14 1.14a.2.2 0 0 1-.2.28h-1.03c-.11.24-.11.49 0 .59s.9.9 1.14 1.14a.2.2 0 0 1-.2.28h-1.03c-.11.24-.11.49 0 .59s.9.9 1.14 1.14a.2.2 0 0 1-.2.28H14.5c-.16 0-.16.24 0 .33s.9.9 1.14 1.14a.2.2 0 0 1 0 .28c-.25.25-1.15.98-1.39 1.24a1.2 1.2 0 0 0-.21.75v3.81c0 .1.1.2.2.2a10 10 0 0 0-1.2-20.01z"></path></svg>
                        <h3>Modo Estudio</h3>
                        <p>Elige un tema de tu Plan de Estudio y recibe una guía priorizada con preguntas clave.</p>
                    </div>
                    <div id="exam-mode-btn" class="mode-card">
                        <svg data-lucide="swords" class="w-16 h-16 text-red-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15.2 2.8 2.9 2.9 4.1 4.1-4.1 4.1-2.9 2.9-4.1-4.1-4.1-4.1 4.1-4.1 2.9-2.9 4.1 4.1z"></path><path d="m5.2 12.8 2.9 2.9 4.1 4.1-4.1 4.1-2.9 2.9-4.1-4.1-4.1-4.1 4.1-4.1 2.9-2.9 4.1 4.1z"></path></svg>
                        <h3>Modo Examen</h3>
                        <p>Genera una simulación al azar con preguntas de todos los temas, como en el examen real.</p>
                    </div>
                </div>

                <div id="study-mode-container" class="space-y-6" style="display: none;">
                    <button id="back-to-mode-selection" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 focus:outline-none inline-flex items-center gap-2">
                        <svg data-lucide="arrow-left" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>
                        Volver
                    </button>
                    
                    <div id="study-mode-topic-selection">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Modo Estudio: Selecciona un Tema</h2>
                        <div id="syllabus-browser" class="syllabus-browser space-y-2 max-h-[500px] overflow-y-auto bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-500">Cargando Plan de Estudio...</p>
                        </div>
                    </div>
                    
                    <div id="study-mode-guide-loader" class="text-center py-10" style="display: none;">
                        <div class="loader mx-auto"></div>
                        <p class="text-lg font-medium text-gray-600 mt-4">Analizando tu material...<br>Creando guía de estudio priorizada.</p>
                    </div>

                    <div id="study-mode-guide-output" class="space-y-6">
                        </div>
                </div>

                <div id="exam-mode-container" class="space-y-6" style="display: none;">
                    <button id="back-to-mode-selection-2" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 focus:outline-none inline-flex items-center gap-2">
                        <svg data-lucide="arrow-left" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>
                        Volver
                    </button>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Modo Examen: Simulación al Azar</h2>

                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                        <label for="questions-slider-exam" class="block text-base font-medium text-gray-700">Preguntas por tema: <span id="questions-count-exam" class="font-bold text-blue-600 text-lg">3</span></label>
                        <input id="questions-slider-exam" type="range" min="1" max="5" value="3" class="w-full mt-2 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    
                    <button id="generate-exam-btn" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-green-600 text-white text-base font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.25 12L17.437 14.846a4.5 4.5 0 00-3.09 3.09L12 20.75l.813-2.846a4.5 4.5 0 003.09-3.09L18.75 12l-2.846-.813a4.5 4.5 0 00-3.09-3.09L12 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L18.75 12z" /></svg>
                        Generar Simulación
                    </button>
                    
                    <div id="exam-loader-exam" class="loader" style="display: none;"></div>
                    
                    <div id="exam-output-exam" class="min-h-[200px] space-y-4">
                        <p class="text-gray-500">Aquí aparecerán las preguntas generadas...</p>
                    </div>
                </div>

            </div>

            <div id="tab-ranking" class="tab-panel space-y-6">
                <p class="text-base text-gray-600">
                    La IA analizará todas las "Experiencias de Exámenes" para identificar los temas más frecuentes.
                </p>
                <button id="generate-ranking" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-indigo-600 text-white text-base font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
                    Analizar y Generar Ranking
                </button>
                
                <div id="ranking-loader" class="loader" style="display: none;"></div>
                
                <div id="ranking-output" class="bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200 min-h-[200px] whitespace-pre-wrap">
                    <p class="text-gray-500">Aquí aparecerá el ranking de temas...</p>
                </div>
            </div>

            <div id="tab-review" class="tab-panel space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-base text-gray-600">
                        Preguntas programadas para repasar hoy. Haz clic en un tema para ver sus preguntas.
                    </p>
                    <div class="text-right">
                        <p class="text-lg font-semibold text-blue-600">
                            <span id="review-due-count">0</span>
                            <span class="text-sm font-normal text-gray-500">para hoy</span>
                        </p>
                        <p class="text-xs text-gray-400">
                            (<span id="review-future-count">0</span> futuras)
                        </p>
                    </div>
                </div>
                <div id="review-loader" class="loader" style="display: none;"></div>
                <div id="review-output" class="min-h-[200px] space-y-4">
                    <p class="text-gray-500">Cargando preguntas guardadas...</p>
                </div>
            </div>

            <div id="tab-units" class="tab-panel space-y-6">
                <p class="text-base text-gray-600">
                    Todas tus preguntas guardadas, organizadas por Unidad y Tema según tu Plan de Estudio.
                </p>
                <div id="units-loader" class="loader" style="display: none;"></div>
                <div id="units-output" class="min-h-[200px] space-y-4">
                    <p class="text-gray-500">Selecciona una materia para ver el repaso por unidades.</p>
                </div>
                <div id="units-progress-container" class="pt-4 border-t border-gray-200" style="display: none;">
                    <p id="units-progress-text" class="text-sm font-medium text-gray-700 text-center mb-2">Progreso General: 0 de 0 (0%)</p>
                    <div class="progress-bar-container">
                        <div id="units-progress-bar" class="progress-bar-fill"></div>
                    </div>
                </div>
            </div>

            <div id="tab-roadmap" class="tab-panel space-y-6">
                <p class="text-base text-gray-600">
                    Preguntas programadas para repasar en el futuro, ordenadas cronológicamente.
                </p>
                <div id="roadmap-loader" class="loader" style="display: none;"></div>
                <div id="roadmap-output" class="min-h-[200px] space-y-4">
                    <p class="text-gray-500">Cargando preguntas futuras...</p>
                </div>
            </div>

        </div>
    </div>

    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none; opacity: 0;">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold text-red-600">Error</h3>
            <p id="error-message" class="mt-2 text-base text-gray-600"></p>
            <button id="close-modal" class="mt-6 w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:outline-none">
                Cerrar
            </button>
        </div>
    </div>

    <div id="edit-qa-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-lg w-full">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Editar Pregunta</h3>
            <input type="hidden" id="edit-qa-doc-id">
            
            <div class="space-y-4">
                <div>
                    <label for="edit-qa-unit" class="block text-sm font-medium text-gray-700">Unidad</label>
                    <input type="text" id="edit-qa-unit" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-qa-topic" class="block text-sm font-medium text-gray-700">Tema</label>
                    <input type="text" id="edit-qa-topic" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-qa-question" class="block text-sm font-medium text-gray-700">Pregunta</label>
                    <textarea id="edit-qa-question" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label for="edit-qa-answer" class="block text-sm font-medium text-gray-700">Respuesta (en HTML)</label>
                    <textarea id="edit-qa-answer" rows="5" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-qa-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 focus:outline-none">
                    Cancelar
                </button>
                <button id="save-edit-qa-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none">
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            setLogLevel,
            collection,
            addDoc,
            serverTimestamp,
            query,
            onSnapshot,
            deleteDoc,
            updateDoc,
            getDocs,
            where,
            orderBy // Importar orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
 
        // --- VARIABLES GLOBALES ---
        let db, auth, appId, userId;
        let currentTab = 'tab-material';
        let currentSubject = ''; // NUEVO: Materia seleccionada
        let allSubjects = new Set(); // NUEVO: Lista de materias
        let savedQuestionsUnsubscribe = null; // Para el listener de onSnapshot
        let futureQuestionsUnsubscribe = null; // NUEVO: Para listener de Hoja de Ruta
 
        // --- ELEMENTOS DEL DOM ---
        const tabButtons = {
            'tab-material': document.getElementById('tab-material-btn'),
            'tab-simulador': document.getElementById('tab-simulador-btn'),
            'tab-ranking': document.getElementById('tab-ranking-btn'),
            'tab-review': document.getElementById('tab-review-btn'),
            'tab-units': document.getElementById('tab-units-btn'), // NUEVO
            'tab-roadmap': document.getElementById('tab-roadmap-btn'), // NUEVO
        };
        const tabPanels = {
            'tab-material': document.getElementById('tab-material'),
            'tab-simulador': document.getElementById('tab-simulador'),
            'tab-ranking': document.getElementById('tab-ranking'),
            'tab-review': document.getElementById('tab-review'),
            'tab-units': document.getElementById('tab-units'), // NUEVO
            'tab-roadmap': document.getElementById('tab-roadmap'), // NUEVO
        };
        
        // Pestaña Material
        const syllabusText = document.getElementById('syllabus');
        const theoryText = document.getElementById('theory');
        const experiencesText = document.getElementById('experiences');
        const saveMaterialBtn = document.getElementById('save-material');
        const saveStatus = document.getElementById('save-status');
        // NUEVO: Botones y inputs de PDF
        const uploadPdfBtns = document.querySelectorAll('.upload-pdf-btn');
        const hiddenPdfInputs = document.querySelectorAll('.hidden-pdf-input');
        
        // Pestaña Simulador (AHORA REDISEÑADA)
        const modeSelectionContainer = document.getElementById('mode-selection-container');
        const studyModeBtn = document.getElementById('study-mode-btn');
        const examModeBtn = document.getElementById('exam-mode-btn');
        // -- Contenedor Modo Estudio
        const studyModeContainer = document.getElementById('study-mode-container');
        const studyModeTopicSelection = document.getElementById('study-mode-topic-selection');
        const syllabusBrowser = document.getElementById('syllabus-browser');
        const studyModeGuideLoader = document.getElementById('study-mode-guide-loader');
        const studyModeGuideOutput = document.getElementById('study-mode-guide-output');
        const backToModeSelectionBtn = document.getElementById('back-to-mode-selection');
        // -- Contenedor Modo Examen (Antiguo Simulador)
        const examModeContainer = document.getElementById('exam-mode-container');
        const questionsSlider = document.getElementById('questions-slider-exam');
        const questionsCount = document.getElementById('questions-count-exam');
        const generateExamBtn = document.getElementById('generate-exam-btn');
        const examLoader = document.getElementById('exam-loader-exam');
        const examOutput = document.getElementById('exam-output-exam');
        const backToModeSelectionBtn2 = document.getElementById('back-to-mode-selection-2');

        
        // Pestaña Ranking
        const generateRankingBtn = document.getElementById('generate-ranking');
        const rankingLoader = document.getElementById('ranking-loader');
        const rankingOutput = document.getElementById('ranking-output');

        // Pestaña Repasar
        const reviewLoader = document.getElementById('review-loader');
        const reviewOutput = document.getElementById('review-output');
        const reviewDueCount = document.getElementById('review-due-count');
        const reviewFutureCount = document.getElementById('review-future-count');

        // Pestaña Repaso por Unidades
        const unitsLoader = document.getElementById('units-loader'); // NUEVO
        const unitsOutput = document.getElementById('units-output'); // NUEVO
        const unitsProgressContainer = document.getElementById('units-progress-container'); // NUEVO
        const unitsProgressText = document.getElementById('units-progress-text'); // NUEVO
        const unitsProgressBar = document.getElementById('units-progress-bar'); // NUEVO

        // Pestaña Hoja de ruta
        const roadmapLoader = document.getElementById('roadmap-loader'); // NUEVO
        const roadmapOutput = document.getElementById('roadmap-output'); // NUEVO
 
        // General
        const subjectSelector = document.getElementById('subject-selector'); // NUEVO
        const newSubjectName = document.getElementById('new-subject-name'); // NUEVO
        const addSubjectBtn = document.getElementById('add-subject-btn'); // NUEVO
        const userIdSpan = document.getElementById('user-id');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const closeModalBtn = document.getElementById('close-modal');

        // NUEVO: Elementos del Modal de Edición
        const editQaModal = document.getElementById('edit-qa-modal');
        const editQaDocId = document.getElementById('edit-qa-doc-id');
        const editQaUnit = document.getElementById('edit-qa-unit');
        const editQaTopic = document.getElementById('edit-qa-topic');
        const editQaQuestion = document.getElementById('edit-qa-question');
        const editQaAnswer = document.getElementById('edit-qa-answer');
        const cancelEditQaBtn = document.getElementById('cancel-edit-qa-btn');
        const saveEditQaBtn = document.getElementById('save-edit-qa-btn');

        // --- INICIALIZACIÓN DE FIREBASE ---
        
        function initializeFirebase() {
            try {
                // Esta es la configuración de tu proyecto de Firebase
                const firebaseConfig = {
                  apiKey: "AIzaSyAVbIeEAHBfKU5eDqsELTyXkAcM-m5qUUM",
                  authDomain: "simulador-examen-oral.firebaseapp.com",
                  projectId: "simulador-examen-oral",
                  storageBucket: "simulador-examen-oral.firebasestorage.app",
                  messagingSenderId: "64722873532",
                  appId: "1:64722873532:web:2f708ee4a62366598c34b9"
                };
                
                if (firebaseConfig.apiKey === "TU_API_KEY") {
                    showModal("Error de configuración: No has introducido tu configuración de Firebase en el archivo HTML. La app no funcionará.");
                    return;
                }

                // Usamos el ID del proyecto como App ID, o puedes poner un string fijo
                appId = firebaseConfig.projectId || 'oral-exam-sim';

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Habilitar logs para depuración

                setupAuth();
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                showModal("No se pudo conectar con la base de datos. Por favor, refresca la página.");
            }
        }

        async function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // La autenticación anónima (user.uid) funcionó.
                    // Ahora, buscamos el ID de SINCRONIZACIÓN (datos).
                    
                    let syncId = localStorage.getItem('my_sync_userId');
                    
                    if (syncId) {
                        // ¡Perfecto! Ya tenemos un ID de sincronización guardado.
                        userId = syncId; // Usamos este ID para TODAS las rutas de datos.
                        userIdSpan.textContent = userId;
                        
                        document.getElementById('sync-id-display').style.display = 'block';
                        document.getElementById('sync-modal').style.display = 'none';

                        // Cargar lista de materias
                        await loadUserSubjects(); 
                        // Configurar listeners de UI
                        setupUIListeners();
                        
                    } else {
                        // Es la primera vez en este dispositivo o se borró el localStorage.
                        // Mostramos el modal para que elija.
                        document.getElementById('sync-id-display').style.display = 'none';
                        document.getElementById('sync-modal').style.display = 'flex';
                    }
                    
                } else {
                    // Usuario no autenticado (raro, pero podría pasar)
                    console.log("Usuario no autenticado.");
                }
            });

            try {
                // Para GitHub Pages, SIEMPRE usamos autenticación anónima.
                // Esto es solo para cumplir la regla de seguridad "request.auth != null".
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error de autenticación:", error);
                showModal("Error de autenticación. La app no funcionará.");
            }
        }

        // --- LÓGICA DE UI (PESTAÑAS Y MODAL) ---

        function switchTab(newTabId) {
            currentTab = newTabId;
            
            Object.keys(tabButtons).forEach(tabId => {
                const btn = tabButtons[tabId];
                const panel = tabPanels[tabId];
                
                if (tabId === newTabId) {
                    btn.classList.add('active');
                    panel.classList.add('active');
                } else {
                    btn.classList.remove('active');
                    panel.classList.remove('active');
                }
            });

            // NUEVO: Cargar datos de pestañas al activarlas (si es necesario)
            if (newTabId === 'tab-units') {
                loadUnitsReview();
            }
            if (newTabId === 'tab-roadmap') {
                setupFutureQuestionsListener();
            }
        }

        function showModal(message) {
            errorMessage.textContent = message;
            errorModal.style.display = 'flex';
            setTimeout(() => errorModal.style.opacity = 1, 10);
        }

        function hideModal() {
            errorModal.style.opacity = 0;
            setTimeout(() => errorModal.style.display = 'none', 300);
        }

        function setupUIListeners() {
            // Navegación de pestañas
            Object.keys(tabButtons).forEach(tabId => {
                tabButtons[tabId].addEventListener('click', () => switchTab(tabId));
            });
            
            // Modal de Error
            closeModalBtn.addEventListener('click', hideModal);
            
            // Listeners de Materia
            addSubjectBtn.addEventListener('click', handleAddSubject);
            subjectSelector.addEventListener('change', handleSubjectChange);
            
            // Pestaña Material
            saveMaterialBtn.addEventListener('click', handleSaveMaterial);
            // NUEVO: Listeners para carga de PDF
            uploadPdfBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.targetTextarea;
                    document.querySelector(`.hidden-pdf-input[data-target-textarea="${targetId}"]`).click();
                });
            });
            hiddenPdfInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && file.type === 'application/pdf') {
                        const targetId = e.currentTarget.dataset.targetTextarea;
                        handlePdfUpload(file, targetId);
                    } else if (file) {
                        showModal("Por favor, selecciona un archivo PDF.");
                    }
                    e.target.value = null; // Reset input
                });
            });
            
            // --- Pestaña Simulador (NUEVOS Listeners) ---
            studyModeBtn.addEventListener('click', showStudyMode);
            examModeBtn.addEventListener('click', showExamMode);
            backToModeSelectionBtn.addEventListener('click', showModeSelection);
            backToModeSelectionBtn2.addEventListener('click', showModeSelection);

            // -- Modo Estudio --
            syllabusBrowser.addEventListener('click', (e) => {
                if (e.target.closest('.unit-toggle-btn')) {
                    handleAccordionToggle(e.target.closest('.unit-toggle-btn'));
                }
                if (e.target.closest('.syllabus-topic-btn')) {
                    const topicBtn = e.target.closest('.syllabus-topic-btn');
                    handleStudyTopicSelect(topicBtn);
                }
            });
            studyModeGuideOutput.addEventListener('click', (e) => {
                if (e.target.closest('.answer-btn')) {
                    handleAnswerClick(e.target.closest('.answer-btn'));
                }
                if (e.target.closest('.save-btn')) {
                    handleSaveClick(e.target.closest('.save-btn'));
                }
                if (e.target.closest('.generate-more-btn')) {
                    handleGenerateMoreQuestions(e.target.closest('.generate-more-btn'));
                }
            });

            // -- Modo Examen --
            questionsSlider.addEventListener('input', (e) => {
                questionsCount.textContent = e.target.value;
            });
            generateExamBtn.addEventListener('click', handleGenerateExam);
            examOutput.addEventListener('click', (e) => {
                if (e.target.closest('.answer-btn')) {
                    handleAnswerClick(e.target.closest('.answer-btn'));
                }
                if (e.target.closest('.save-btn')) {
                    handleSaveClick(e.target.closest('.save-btn'));
                }
            });
            // --- Fin Listeners Simulador ---
            
            // Pestaña Ranking
            generateRankingBtn.addEventListener('click', handleGenerateRanking);

            // Pestaña Repasar (Hoy)
            reviewOutput.addEventListener('click', (e) => {
                if (e.target.closest('.delete-qa-btn')) {
                    handleDeleteClick(e.target.closest('.delete-qa-btn'));
                }
                if (e.target.closest('.show-answer-btn')) {
                    handleShowAnswerClick(e.target.closest('.show-answer-btn'));
                }
                if (e.target.closest('.rate-btn')) {
                    handleRateClick(e.target.closest('.rate-btn'));
                }
                if (e.target.closest('.topic-toggle-btn')) {
                    handleAccordionToggle(e.target.closest('.topic-toggle-btn'));
                }
            });

            // --- INICIO: Listener MODIFICADO para Repaso por Unidades ---
            unitsOutput.addEventListener('click', (e) => {
                if (e.target.closest('.delete-qa-btn')) {
                    // Detener que el clic en "borrar" active el clic en "pregunta"
                    e.stopPropagation(); 
                    handleDeleteClick(e.target.closest('.delete-qa-btn'));
                } else if (e.target.closest('.edit-qa-btn')) { // NUEVO
                    e.stopPropagation();
                    handleEditClick(e.target.closest('.edit-qa-btn'));
                } else if (e.target.closest('.unit-toggle-btn')) {
                    handleAccordionToggle(e.target.closest('.unit-toggle-btn'));
                } else if (e.target.closest('.topic-toggle-btn-units')) {
                    handleAccordionToggle(e.target.closest('.topic-toggle-btn-units'));
                } else if (e.target.closest('.question-toggle-btn-units')) {
                    // El selector de respuesta es específico para este nivel
                    handleAccordionToggle(e.target.closest('.question-toggle-btn-units'), '.answer-container-units');
                }
            });
            // --- FIN: Listener MODIFICADO para Repaso por Unidades ---

            // Pestaña Hoja de Ruta (solo borrado)
            roadmapOutput.addEventListener('click', (e) => {
                if (e.target.closest('.delete-qa-btn')) {
                    handleDeleteClick(e.target.closest('.delete-qa-btn'));
                }
            });

            // Cargar íconos iniciales (NUEVO: movido aquí)
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            // NUEVO: Listeners para el Modal de Edición
            cancelEditQaBtn.addEventListener('click', () => {
                editQaModal.style.display = 'none';
            });
            saveEditQaBtn.addEventListener('click', handleSaveChanges);
        }
        
        // --- NUEVAS FUNCIONES PARA MANEJO DE MATERIAS ---

        /**
         * Carga la lista de materias del usuario desde Firestore.
         */
        async function loadUserSubjects() {
            if (!userId) return;
            const subjectsRef = collection(db, 'artifacts', appId, 'users', userId, 'subjects');
            try {
                const querySnapshot = await getDocs(subjectsRef);
                allSubjects = new Set();
                querySnapshot.forEach((doc) => {
                    allSubjects.add(doc.id); // El ID del doc es el nombre de la materia
                });
                renderSubjectSelector();
            } catch (error) {
                console.error("Error cargando materias:", error);
                showModal("No se pudieron cargar tus materias.");
            }
        }

        /**
         * Rellena el <select> de materias.
         */
        function renderSubjectSelector() {
            subjectSelector.innerHTML = '<option value="">-- Selecciona una Materia --</option>';
            allSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelector.appendChild(option);
            });
        }

        /**
         * Maneja el clic para crear una nueva materia.
         */
        async function handleAddSubject() {
            const newSubject = newSubjectName.value.trim();
            if (!newSubject) {
                showModal("El nombre de la materia no puede estar vacío.");
                return;
            }
            if (allSubjects.has(newSubject)) {
                showModal("Esa materia ya existe.");
                return;
            }

            try {
                // Crear un doc placeholder para que la materia "exista"
                const subjectDocRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', newSubject);
                await setDoc(subjectDocRef, { createdAt: serverTimestamp() });
                
                allSubjects.add(newSubject);
                renderSubjectSelector();
                subjectSelector.value = newSubject;
                newSubjectName.value = '';
                
                // Disparar el cambio de materia
                handleSubjectChange(); 

            } catch (error) {
                console.error("Error creando materia:", error);
                showModal("No se pudo crear la materia.");
            }
        }

        /**
         * Se dispara cuando el usuario cambia la materia en el <select>.
         */
        async function handleSubjectChange() {
            currentSubject = subjectSelector.value;
            if (!currentSubject) {
                clearMaterialUI();
                clearReviewUI();
                clearUnitsUI(); // NUEVO
                clearRoadmapUI(); // NUEVO
                return;
            }
            
            // Ahora que tenemos materia, cargamos todo
            await loadMaterialFromFirestore();
            setupSavedQuestionsListener(); // Esto se reconfigura y se dispara
            setupFutureQuestionsListener(); // NUEVO: Configurar listener de hoja de ruta
            loadUnitsReview(); // NUEVO: Cargar datos de "Repaso por Unidades"
        }

        /**
         * Limpia los textareas de material.
         */
        function clearMaterialUI() {
            syllabusText.value = '';
            theoryText.value = '';
            experiencesText.value = '';
            saveStatus.textContent = '';
        }

        /**
         * Limpia la pestaña de repaso y detiene el listener.
         */
        function clearReviewUI() {
            if (savedQuestionsUnsubscribe) {
                savedQuestionsUnsubscribe();
                savedQuestionsUnsubscribe = null;
            }
            reviewOutput.innerHTML = '<p class="text-gray-500">Selecciona una materia para ver las preguntas.</p>';
            reviewDueCount.textContent = '0';
            reviewFutureCount.textContent = '0';
        }

        /**
         * NUEVO: Limpia la pestaña de repaso por unidades.
         */
        function clearUnitsUI() {
            unitsOutput.innerHTML = '<p class="text-gray-500">Selecciona una materia para ver el repaso por unidades.</p>';
            unitsProgressContainer.style.display = 'none';
        }

        /**
         * NUEVO: Limpia la pestaña de hoja de ruta.
         */
        function clearRoadmapUI() {
            if (futureQuestionsUnsubscribe) {
                futureQuestionsUnsubscribe();
                futureQuestionsUnsubscribe = null;
            }
            roadmapOutput.innerHTML = '<p class="text-gray-500">Selecciona una materia para ver la hoja de ruta.</p>';
        }


        // --- LÓGICA DE FIRESTORE (MATERIAL) ---

        async function getMaterialRef(materialType) {
            if (!userId) {
                showModal("Usuario no autenticado. No se puede operar.");
                return null;
            }
            if (!currentSubject) {
                console.warn("Intento de acceso a material sin materia seleccionada.");
                return null;
            }
            // La ruta ahora incluye la materia
            return doc(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'materials', materialType);
        }

        async function handleSaveMaterial() {
            if (!currentSubject) {
                showModal("Por favor, selecciona o crea una materia primero.");
                return;
            }
            saveStatus.textContent = "Guardando...";
            saveMaterialBtn.disabled = true;

            try {
                const materialsToSave = [
                    { id: 'syllabus', content: syllabusText.value },
                    { id: 'theory', content: theoryText.value },
                    { id: 'experiences', content: experiencesText.value }
                ];
                
                for (const mat of materialsToSave) {
                    const docRef = await getMaterialRef(mat.id);
                    if(docRef) {
                        await setDoc(docRef, { content: mat.content });
                    }
                }
                
                saveStatus.textContent = "¡Material guardado en la nube exitosamente!";
                // NUEVO: Recalcular progreso al guardar material (plan de estudios)
                loadUnitsReview();
                setTimeout(() => saveStatus.textContent = "", 3000);

            } catch (error) {
                console.error("Error al guardar:", error);
                showModal(`Error al guardar material: ${error.message}`);
                saveStatus.textContent = "Error al guardar.";
            } finally {
                saveMaterialBtn.disabled = false;
            }
        }
        
        async function loadMaterialFromFirestore() {
            if (!currentSubject) {
                clearMaterialUI();
                return;
            }
            try {
                const materialsToLoad = [
                    { id: 'syllabus', element: syllabusText },
                    { id: 'theory', element: theoryText },
                    { id: 'experiences', element: experiencesText }
                ];

                for (const mat of materialsToLoad) {
                    const docRef = await getMaterialRef(mat.id);
                    if(!docRef) continue;
                    
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        mat.element.value = docSnap.data().content || "";
                    } else {
                        mat.element.value = "";
                    }
                }
            } catch (error) {
                console.error("Error al cargar:", error);
                showModal(`No se pudo cargar el material guardado: ${error.message}`);
            }
        }

        async function getAllMaterials() {
            let materials = {
                syllabus: "",
                theory: "",
                experiences: ""
            };
            try {
                const syllabusRef = await getMaterialRef('syllabus');
                const theoryRef = await getMaterialRef('theory');
                const experiencesRef = await getMaterialRef('experiences');

                if(syllabusRef) {
                    const syllabusSnap = await getDoc(syllabusRef);
                    if (syllabusSnap.exists()) materials.syllabus = syllabusSnap.data().content;
                }
                
                if(theoryRef) {
                    const theorySnap = await getDoc(theoryRef);
                    if (theorySnap.exists()) materials.theory = theorySnap.data().content;
                }

                if(experiencesRef) {
                    const experiencesSnap = await getDoc(experiencesRef);
                    if (experiencesSnap.exists()) materials.experiences = experiencesSnap.data().content;
                }
                
                return materials;
            } catch (error) {
                console.error("Error al obtener materiales:", error);
                showModal("Error al leer los materiales de la base de datos.");
                return null; // Devolver null en caso de error
            }
        }

        // --- LÓGICA de IA (GEMINI API) ---
        
        async function callGemini(systemPrompt, userQuery, generationConfig = null) {
            // --- ¡IMPORTANTE! ---
            // Clave API integrada
            const apiKey = "AIzaSyA1RYWX9v5UFVVGVcI9KKyPXK3BDnIRkqw"; // Clave API integrada
            // --- FIN ---

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            if (generationConfig) {
                payload.generationConfig = generationConfig;
            }

            let response;
            let retries = 0;
            const maxRetries = 3;

            while (retries < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            throw new Error("Respuesta de la IA inválida o vacía.");
                        }
                    } else {
                        const errorBody = await response.text();
                        console.error(`Error ${response.status} en callGemini:`, errorBody);
                        let specificError = errorBody;
                        try {
                            const errorJson = JSON.parse(errorBody);
                            specificError = errorJson.error?.message || errorBody;
                        } catch (e) { /* No era JSON */ }
                        throw new Error(`Error en API Gemini (${response.status}): ${specificError}`);
                    }
                } catch (error) {
                    console.error(`Intento ${retries + 1} fallido (callGemini):`, error);
                    retries++;
                    if (retries >= maxRetries) {
                        throw error; // Lanza el error final después de todos los intentos
                    }
                    const delay = Math.pow(2, retries) * 1000; // 1s, 2s, 4s
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- FUNCIONES DE TTS (TEXT-TO-SPEECH) ---
        async function callGeminiTTS(textToSpeak) {
            // --- ¡IMPORTANTE! ---
            // Clave API integrada
            const apiKey = "AIzaSyA1RYWX9v5UFVVGVcI9KKyPXK3BDnIRkqw"; // Clave API integrada
            // --- FIN ---

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: `Di con tono claro e informativo: ${textToSpeak}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } 
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`Error ${response.status} en callGeminiTTS:`, errorBody);
                    let specificError = errorBody;
                    try {
                        const errorJson = JSON.parse(errorBody);
                        specificError = errorJson.error?.message || errorBody;
                    } catch (e) { /* No era JSON */ }
                    throw new Error(`Error en API TTS (${response.status}): ${specificError}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    return { audioData, mimeType };
                } else {
                    throw new Error("Respuesta de audio TTS inválida o no encontrada.");
                }
            } catch (error) {
                console.error("Error en callGeminiTTS:", error);
                throw error;
            }
        }
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);
            const pcm16 = new Int16Array(pcmData);
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcm16[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }
        async function playAudio(audioData, mimeType, playerContainer) {
            try {
                const rateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                playerContainer.innerHTML = '';
                const audio = document.createElement('audio');
                audio.src = audioUrl;
                audio.controls = true;
                playerContainer.appendChild(audio);
                audio.play();
            } catch (error) {
                console.error("Error al reproducir audio:", error);
                playerContainer.textContent = "Error al procesar audio.";
            }
        }

        // --- NUEVO: Función para convertir Markdown simple a HTML ---
        function convertMarkdownToHTML(text) {
            if (!text) return "";
            // Negrita: **texto** -> <b>texto</b>
            // Usamos una regex global para reemplazar todas las instancias
            let html = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            // Podríamos añadir más (ej. *cursiva*), pero por ahora solo negrita
            return html;
        }
        
        // --- FUNCIÓN PARA OBTENER RESPUESTA DE IA ---
        
        async function getAnswerForQuestion(question, materials) {
            // --- INICIO DE LA MODIFICACIÓN ---
            const systemPrompt = "Eres un profesor experto. Responde la siguiente pregunta de examen de forma concisa y directa, basándote en el material de estudio proporcionado. La respuesta debe ser ideal para un examen oral. IMPORTANTE: Para resaltar texto clave, usa el formato Markdown `**texto en negrita**`. No utilices ningún otro formato.";
            // --- FIN DE LA MODIFICACIÓN ---
            const userQuery = `
                Material de Estudio (Contexto):
                --- PLAN DE ESTUDIO ---
                ${materials.syllabus || "No proporcionado."}
                --- TEORÍA Y CASOS CLÍNICOS ---
                ${materials.theory || "No proporcionado."}
                --- EXPERIENCIAS PASADAS ---
                ${materials.experiences || "No proporcionado."}
                --- FIN DEL MATERIAL ---

                Pregunta a responder:
                "${question}"

                Por favor, genera una respuesta clara y concisa para esta pregunta.
            `;
            try {
                const answer = await callGemini(systemPrompt, userQuery);
                return answer;
            } catch (error) {
                console.error("Error en getAnswerForQuestion:", error);
                throw error; // Re-lanzar el error para que handleAnswerClick lo atrape
            }
        }


        // --- MANEJADORES DE EVENTOS PRINCIPALES ---
        
        // --- INICIO: NUEVAS Funciones para "Modo Estudio" y "Modo Examen" ---
        
        function showModeSelection() {
            modeSelectionContainer.style.display = 'grid';
            studyModeContainer.style.display = 'none';
            examModeContainer.style.display = 'none';
        }

        function showStudyMode() {
            modeSelectionContainer.style.display = 'none';
            studyModeContainer.style.display = 'block';
            examModeContainer.style.display = 'none';
            // Cargar el navegador del syllabus
            renderSyllabusBrowser();
        }

        function showExamMode() {
            modeSelectionContainer.style.display = 'none';
            studyModeContainer.style.display = 'none';
            examModeContainer.style.display = 'block';
        }

        // --- INICIO: Nueva función para parsear el Syllabus con IA ---
        async function parseSyllabusWithAI(syllabusText) {
            const systemPrompt = `
                Eres un asistente de organización académica. 
                Tu tarea es leer un plan de estudios (syllabus) y estructurarlo en un formato JSON.
                Identifica las 'unidades' (temas principales o bolillas) y los 'temas' (subtemas o contenidos) dentro de cada una.

                Reglas:
                1. Si el plan de estudios está claramente dividido por "Unidad X" o "Bolilla X", úsalas como "unit".
                2. Las líneas que siguen a una unidad (y que no son otra unidad) son sus "topics".
                3. Si el plan solo lista temas (ej. "Tema 1: ...", "Tema 2: ..."), crea una sola unidad llamada "Temas Generales" y lista todos los temas como "topics".
                4. Interpreta el contenido de forma inteligente. Por ejemplo, si una línea es "Unidad 5. Alcoholes." y la siguiente es "Etanol, metanol, isopropanol.", la segunda línea es un "topic" (o varios) de la Unidad 5.
            `;

            const jsonSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "unit": { 
                            "type": "STRING", 
                            "description": "El nombre de la unidad o bolilla principal." 
                        },
                        "topics": {
                            "type": "ARRAY",
                            "description": "Una lista de los temas o subtemas dentro de esa unidad.",
                            "items": { "type": "STRING" }
                        }
                    },
                    "required": ["unit", "topics"]
                }
            };
            
            const generationConfig = {
                responseMimeType: "application/json",
                responseSchema: jsonSchema
            };

            const userQuery = `
                Por favor, parsea el siguiente plan de estudios. Asegúrate de agrupar los temas bajo sus unidades correctas:
                --- INICIO PLAN DE ESTUDIOS ---
                ${syllabusText}
                --- FIN PLAN DE ESTUDIOS ---
            `;

            try {
                const resultText = await callGemini(systemPrompt, userQuery, generationConfig);
                return JSON.parse(resultText);
            } catch (error) {
                console.error("Error en parseSyllabusWithAI:", error);
                throw new Error(`La IA no pudo procesar el plan de estudio: ${error.message}`);
            }
        }

        /**
         * Parsea y renderiza el Plan de Estudio como un acordeón para el Modo Estudio.
         * MODIFICADO: Ahora usa IA para parsear el syllabus.
         */
        async function renderSyllabusBrowser() {
            const syllabus = syllabusText.value;
            if (!syllabus || syllabus.trim() === '') {
                syllabusBrowser.innerHTML = '<p class="text-gray-500">No has cargado un Plan de Estudio en la pestaña "Material".</p>';
                return;
            }

            // Mostrar loader mientras la IA analiza
            syllabusBrowser.innerHTML = `
                <div class="text-center py-4">
                    <div class="loader mx-auto"></div>
                    <p class="text-gray-600 mt-2">Analizando tu Plan de Estudio...</p>
                </div>`;
            
            let groupedSyllabus = [];

            try {
                // --- ¡CAMBIO CLAVE! ---
                // Ya no usamos el parser simple, llamamos a la IA
                groupedSyllabus = await parseSyllabusWithAI(syllabus);
                // --- FIN DEL CAMBIO ---

                if (!groupedSyllabus || groupedSyllabus.length === 0) {
                     syllabusBrowser.innerHTML = '<p class="text-red-500">La IA no pudo encontrar temas estructurados en tu plan de estudio.</p>';
                     return;
                }
                
                // Renderizar el acordeón (esta lógica es la misma de antes)
                syllabusBrowser.innerHTML = ''; // Limpiar loader
                groupedSyllabus.forEach((unitData, index) => {
                    const unitGroupEl = document.createElement('div');
                    unitGroupEl.className = 'unit-group';
                    
                    // Botón de Unidad
                    const unitButton = document.createElement('button');
                    unitButton.className = 'unit-toggle-btn';
                    unitButton.setAttribute('aria-expanded', 'false');
                    unitButton.innerHTML = `
                        <span>${unitData.unit}</span>
                        <span class="toggle-icon" data-lucide="chevron-down"></span>
                    `;
                    unitGroupEl.appendChild(unitButton);

                    // Contenedor de Temas (oculto)
                    const unitTopicsContainer = document.createElement('div');
                    unitTopicsContainer.className = 'unit-topics-container';
                    unitGroupEl.appendChild(unitTopicsContainer);

                    if (unitData.topics.length > 0) {
                        unitData.topics.forEach(topic => {
                            const topicButton = document.createElement('button');
                            topicButton.className = 'syllabus-topic-btn';
                            topicButton.textContent = topic;
                            topicButton.dataset.unit = unitData.unit;
                            topicButton.dataset.topic = topic;
                            unitTopicsContainer.appendChild(topicButton);
                        });
                    } else {
                        // Esto ahora solo debería aparecer si la IA devuelve una unidad con un array de topics vacío
                        unitTopicsContainer.innerHTML = '<p class="text-gray-500 p-4">No hay temas listados para esta unidad.</p>';
                    }
                    syllabusBrowser.appendChild(unitGroupEl);
                });
                
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            } catch (error) {
                 console.error("Error en renderSyllabusBrowser:", error);
                 syllabusBrowser.innerHTML = `<p class="text-red-500">Error al analizar el plan de estudio: ${error.message}</p>`;
            }
        }
        
        // --- FIN DE LAS FUNCIONES MODIFICADAS ---


        /**
         * Se llama al seleccionar un tema en el Modo Estudio.
         */
        async function handleStudyTopicSelect(topicButton) {
            const topicName = topicButton.dataset.topic;
            const unitName = topicButton.dataset.unit;

            if (!topicName || !unitName) return;

            studyModeTopicSelection.style.display = 'none';
            studyModeGuideLoader.style.display = 'block';
            studyModeGuideOutput.innerHTML = '';

            const materials = await getAllMaterials();
            if (!materials) {
                studyModeGuideLoader.style.display = 'none';
                studyModeTopicSelection.style.display = 'block'; // Volver
                return;
            }

            try {
                const guideData = await generatePrioritizedStudyGuide(topicName, unitName, materials);
                renderStudyGuide(guideData, unitName);
            } catch (error) {
                console.error("Error al generar guía de estudio:", error);
                showModal(`No se pudo generar la guía: ${error.message}`);
                studyModeGuideOutput.innerHTML = `<p class="text-red-500">Error al generar la guía.</p>`;
            } finally {
                studyModeGuideLoader.style.display = 'none';
            }
        }

        /**
         * Llama a la IA para crear la guía de estudio priorizada.
         */
        async function generatePrioritizedStudyGuide(topicName, unitName, materials) {
            const systemPrompt = "Eres un Tutor Médico experto. El estudiante quiere estudiar un tema. Analiza su material (Teoría) y las preguntas de examen (Experiencias). Tu misión es crear una Guía de Estudio Priorizada en formato JSON. Identifica 5-7 subtemas clave. Para cada subtema, asigna una Importancia (Alta, Media, Baja) basándote en las Experiencias y la Teoría, justifica tu elección brevemente, y crea una 'pregunta clave' excelente para ese subtema.";
            
            const jsonSchema = {
                type: "OBJECT",
                properties: {
                    "topic": { "type": "STRING" },
                    "ai_summary": { "type": "STRING" },
                    "subtopics": {
                        "type": "ARRAY",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "subtopic_name": { "type": "STRING" },
                                "importance": { "type": "STRING" },
                                "justification": { "type": "STRING" },
                                "key_question": { "type": "STRING" }
                            },
                            "required": ["subtopic_name", "importance", "justification", "key_question"]
                        }
                    }
                },
                "required": ["topic", "ai_summary", "subtopics"]
            };

            const generationConfig = {
                responseMimeType: "application/json",
                responseSchema: jsonSchema
            };

            const userQuery = `
                Material del Estudiante:
                --- PLAN DE ESTUDIO (Contexto) ---
                ${materials.syllabus || "No proporcionado."}
                --- TEORÍA / APUNTES ---
                ${materials.theory || "No proporcionado."}
                --- EXPERIENCIAS DE EXÁMENES ---
                ${materials.experiences || "No proporcionado."}
                --- FIN DEL MATERIAL ---

                Tema a Estudiar: "${topicName}" (de la unidad: "${unitName}")

                Por favor, genera la Guía de Estudio Priorizada en JSON.
            `;
            
            const resultText = await callGemini(systemPrompt, userQuery, generationConfig);
            return JSON.parse(resultText);
        }

        /**
         * Renderiza la Guía de Estudio Priorizada en la UI.
         */
        function renderStudyGuide(guideData, unitName) {
            studyModeGuideOutput.innerHTML = ''; // Limpiar
            
            // Título y Resumen
            const title = document.createElement('h2');
            title.className = 'text-3xl font-bold text-gray-800 mb-4';
            title.textContent = `Guía de Estudio: ${guideData.topic}`;
            
            const summary = document.createElement('p');
            summary.className = 'guide-summary';
            summary.textContent = guideData.ai_summary;
            
            studyModeGuideOutput.appendChild(title);
            studyModeGuideOutput.appendChild(summary);

            // Renderizar cada subtema
            guideData.subtopics.forEach(subtopic => {
                const block = document.createElement('div');
                block.className = 'subtopic-block';

                // Importancia (para el badge)
                let importanceClass = 'importance-badge-baja'; // Default
                if (subtopic.importance.toLowerCase().includes('alta')) {
                    importanceClass = 'importance-badge-alta';
                } else if (subtopic.importance.toLowerCase().includes('media')) {
                    importanceClass = 'importance-badge-media';
                }

                block.innerHTML = `
                    <div class="subtopic-header">
                        <h4>${subtopic.subtopic_name}</h4>
                        <span class="importance-badge ${importanceClass}">${subtopic.importance}</span>
                    </div>
                    <div class="subtopic-body">
                        <p class="ai-justification">${subtopic.justification}</p>
                        
                        <div class="key-question-wrapper">
                            </div>
                        
                        <div class="sub-question-container"></div>
                        <div class="sub-question-loader loader"></div>
                    </div>
                    
                    <button class="generate-more-btn" data-unit="${unitName}" data-topic="${guideData.topic}" data-subtopic="${subtopic.subtopic_name}">
                        <svg data-lucide="plus" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                        Generar más preguntas de este subtema
                    </button>
                `;
                
                // Generar y añadir la pregunta clave
                const keyQuestionWrapper = block.querySelector('.key-question-wrapper');
                const questionHTML = createQuestionItemHTML(subtopic.key_question, unitName, guideData.topic);
                keyQuestionWrapper.innerHTML = questionHTML;

                studyModeGuideOutput.appendChild(block);
            });
            
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }

        /**
         * Genera más preguntas para un subtema específico.
         */
        async function handleGenerateMoreQuestions(button) {
            const unitName = button.dataset.unit;
            const topicName = button.dataset.topic;
            const subtopicName = button.dataset.subtopic;
            const container = button.previousElementSibling.querySelector('.sub-question-container');
            const loader = button.previousElementSibling.querySelector('.sub-question-loader');
            
            if (!unitName || !topicName || !subtopicName || !container || !loader) {
                console.error("Faltan datos en el botón 'Generar Más'");
                return;
            }

            button.disabled = true;
            loader.style.display = 'block';

            const materials = await getAllMaterials();
            if (!materials) {
                button.disabled = false;
                loader.style.display = 'none';
                return;
            }

            const systemPrompt = "Eres un Tutor Médico. Genera 3 preguntas de examen oral, cortas y directas, sobre el siguiente subtema. No te repitas. Responde solo con la lista de preguntas, cada una en una nueva línea.";
            const userQuery = `
                Material del Estudiante:
                --- TEORÍA (Contexto) ---
                ${materials.theory || "No proporcionado."}
                --- EXPERIENCIAS (Contexto) ---
                ${materials.experiences || "No proporcionado."}
                --- FIN DEL MATERIAL ---

                Tema Principal: "${topicName}"
                Subtema Específico: "${subtopicName}"

                Genera 3 preguntas solo sobre el subtema específico.
            `;

            try {
                const resultText = await callGemini(systemPrompt, userQuery);
                const newQuestions = resultText.split('\n').filter(q => q.trim().length > 0);
                
                newQuestions.forEach(q => {
                    const questionHTML = createQuestionItemHTML(q, unitName, topicName);
                    container.insertAdjacentHTML('beforeend', questionHTML);
                });
                
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            } catch (error) {
                console.error("Error generando más preguntas:", error);
                container.innerHTML += '<p class="text-red-500 text-sm">Error al generar preguntas.</p>';
            } finally {
                button.disabled = false;
                loader.style.display = 'none';
            }
        }


        /**
         * Helper para crear el HTML de un item de pregunta (para Modo Estudio)
         */
        function createQuestionItemHTML(question, unitName, topicName) {
            // Este HTML es una réplica del usado en 'renderExamUI'
            return `
                <div class="question-item py-4">
                    <p class="question-text">${question}</p>
                    <button class="answer-btn mt-3 px-4 py-1.5 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 transition-colors inline-flex items-center" data-question="${question}">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z"></path></svg>
                        Responder y Escuchar
                        <div class="answer-loader" style="display: none;"></div>
                    </button>
                    <button class="save-btn mt-3 ml-2 px-4 py-1.5 bg-green-500 text-white text-sm font-medium rounded-md hover:bg-green-600 transition-colors inline-flex items-center" data-question="${question}" data-topic="${topicName}" data-unit="${unitName}" style="display: none;">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0111.186 0zM17.593 3.322c.107.014.215.026.32.04a48.196 48.196 0 00-11.83 0c.105-.014.213-.026.32-.04m11.19 0A48.25 48.25 0 0012 3c-2.755 0-5.459.436-8.093 1.1262M12 12v3.75m0-9.75v.01"></path></svg>
                        Guardar
                    </button>
                    <div class="answer-text" contenteditable="false" style="display: none;"></div>
                    <div class="audio-player-container"></div>
                </div>
            `;
        }

        // --- FIN: NUEVAS Funciones para "Modo Estudio" ---


        /**
         * Manejador para el "Modo Examen" (el simulador antiguo)
         */
        async function handleGenerateExam() {
            examLoader.style.display = 'block';
            generateExamBtn.disabled = true;
            examOutput.innerHTML = "<p>Generando preguntas... Esto puede tardar un momento.</p>";

            const materials = await getAllMaterials();
            if (!materials) {
                examLoader.style.display = 'none';
                generateExamBtn.disabled = false;
                return;
            }
            
            if (!currentSubject) {
                 showModal("Por favor, selecciona una materia primero.");
                examLoader.style.display = 'none';
                generateExamBtn.disabled = false;
                examOutput.innerHTML = "<p class='text-gray-500'>Aquí aparecerán las preguntas generadas...</p>";
                return;
            }

            if (!materials.syllabus && !materials.theory && !materials.experiences) {
                showModal("No hay material cargado para esta materia. Por favor, ve a la pestaña 'Material' y guarda contenido primero.");
                examLoader.style.display = 'none';
                generateExamBtn.disabled = false;
                examOutput.innerHTML = "<p class='text-gray-500'>Aquí aparecerán las preguntas generadas...</p>";
                return;
            }

            const questionsPerTopic = questionsSlider.value;
            const systemPrompt = "Eres un asistente experto en educación que simula un examen oral. Tu tarea es generar preguntas para un examen oral basándote en el material. Debes devolver un objeto JSON.";
            // --- NUEVO: Esquema JSON actualizado ---
            const jsonSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "unidad": { "type": "STRING" },
                        "tema": { "type": "STRING" },
                        "preguntas": {
                            "type": "ARRAY",
                            "items": { "type": "STRING" }
                        }
                    },
                    "required": ["unidad", "tema", "preguntas"]
                }
            };
            const generationConfig = {
                responseMimeType: "application/json",
                responseSchema: jsonSchema
            };
            const userQuery = `
                Basado en los siguientes materiales:
                --- PLAN DE ESTUDIO ---
                ${materials.syllabus || "No proporcionado."}
                --- TEORÍA Y CASOS CLÍNICOS ---
                ${materials.theory || "No proporcionado."}
                --- EXPERIENCIAS PASADAS ---
                ${materials.experiences || "No proporcionado."}
                --- FIN EXPERIENCIAS ---
                Genera una simulación de examen oral. Sigue estas reglas:
                1. Identifica 3 (tres) temas principales distintos *al azar* de todo el material.
                2. Para CADA tema, identifica a qué "Unidad" pertenece basándote en el PLAN DE ESTUDIO. Si no encuentras una unidad, usa "Unidad General".
                3. Para CADA uno de los 3 temas, genera exactamente ${questionsPerTopic} preguntas cortas, directas y concisas.
                4. Si el material incluye "casos clínicos", intenta que una pregunta sea un caso clínico breve.
                5. Responde ÚNICAMENTE con el array JSON que cumple el esquema.
            `;

            try {
                const resultText = await callGemini(systemPrompt, userQuery, generationConfig);
                const examData = JSON.parse(resultText);
                renderExamUI(examData);
            } catch (error) {
                console.error("Error al generar examen:", error);
                showModal(`Error al comunicarse con la IA o procesar su respuesta: ${error.message}`);
                examOutput.innerHTML = "<p>Ocurrió un error al generar las preguntas.</p>";
            } finally {
                examLoader.style.display = 'none';
                generateExamBtn.disabled = false;
            }
        }

        /**
         * Renderiza la UI del "Modo Examen"
         */
        function renderExamUI(examData) {
            examOutput.innerHTML = ''; // Limpiar
            if (!examData || examData.length === 0) {
                examOutput.textContent = "No se pudieron generar preguntas.";
                return;
            }

            examData.forEach((topic, index) => {
                const topicEl = document.createElement('div');
                topicEl.className = 'mb-6 p-4 border rounded-xl bg-gray-50 shadow-inner';
                
                const topicTitle = document.createElement('h3');
                topicTitle.className = 'text-xl font-bold text-blue-800 mb-1';
                topicTitle.textContent = `Tema ${index + 1}: ${topic.tema}`;
                
                // NUEVO: Mostrar la Unidad
                const unitTitle = document.createElement('p');
                unitTitle.className = 'text-sm font-medium text-gray-500 mb-4';
                unitTitle.textContent = `(Unidad: ${topic.unidad || 'General'})`;
                
                topicEl.appendChild(topicTitle);
                topicEl.appendChild(unitTitle);

                topic.preguntas.forEach((question) => {
                    // Reutilizar el helper para consistencia
                    const questionHTML = createQuestionItemHTML(question, topic.unidad || 'Unidad General', topic.tema);
                    topicEl.insertAdjacentHTML('beforeend', questionHTML);
                });

                examOutput.appendChild(topicEl);
            });
        }
        
        /**
         * Manejador de clic de "Responder y Escuchar" (Unificado)
         */
        async function handleAnswerClick(button) {
            const question = button.dataset.question;
            const container = button.closest('.question-item');
            const loader = button.querySelector('.answer-loader');
            const answerTextEl = container.querySelector('.answer-text');
            const audioPlayerContainer = container.querySelector('.audio-player-container');
            const saveButton = container.querySelector('.save-btn'); 

            button.disabled = true;
            loader.style.display = 'inline-block';
            answerTextEl.style.display = 'none';
            answerTextEl.innerHTML = 'Generando respuesta...';
            audioPlayerContainer.innerHTML = '';
            if (saveButton) saveButton.style.display = 'none'; 

            try {
                const materials = await getAllMaterials();
                if (!materials) throw new Error("No se pudo cargar el material de contexto.");
                
                answerTextEl.style.display = 'block';
                const answerText = await getAnswerForQuestion(question, materials);
                // --- NUEVO: Usar función de conversión ---
                answerTextEl.innerHTML = convertMarkdownToHTML(answerText);
                answerTextEl.contentEditable = true;


                answerTextEl.innerHTML += "\n\nGenerando audio...";
                // Quitar Markdown/HTML para el audio
                const cleanAnswerForTTS = answerText.replace(/\*\*(.*?)\*\*/g, '$1'); 
                const { audioData, mimeType } = await callGeminiTTS(cleanAnswerForTTS);
                
                answerTextEl.innerHTML = convertMarkdownToHTML(answerText); // Restaurar texto limpio con HTML
                await playAudio(audioData, mimeType, audioPlayerContainer);

                if (saveButton) {
                    saveButton.style.display = 'inline-flex'; 
                    saveButton.disabled = false;
                    saveButton.innerHTML = `<svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0111.186 0zM17.593 3.322c.107.014.215.026.32.04a48.196 48.196 0 00-11.83 0c.105-.014.213-.026.32-.04m11.19 0A48.25 48.25 0 0012 3c-2.755 0-5.459.436-8.093 1.262M12 12v3.75m0-9.75v.01" /></svg>
                            Guardar`;
                }

            } catch (error) {
                console.error("Error en handleAnswerClick:", error);
                answerTextEl.innerHTML = `Error: ${error.message}`; 
                answerTextEl.style.display = 'block';
            } finally {
                button.disabled = false;
                loader.style.display = 'none';
            }
        }

        // --- FUNCIONES PARA GUARDAR Y REPASAR ---

        /**
         * Manejador de clic de "Guardar" (Unificado)
         */
        async function handleSaveClick(button) {
            const topic = button.dataset.topic;
            const question = button.dataset.question;
            const unit = button.dataset.unit;
            
            /* --- MODIFICACIÓN: Leer la respuesta desde el div editable --- */
            const container = button.closest('.question-item');
            const answerTextEl = container.querySelector('.answer-text');
            const answer = answerTextEl.innerHTML; // Ya está en HTML (con <b>)
            /* --- FIN DE MODIFICACIÓN --- */

            if (!currentSubject) {
                showModal("Por favor, selecciona una materia antes de guardar.");
                return;
            }

            // --- FIX: Comprobar todas las variables ---
            if (!topic || !question || !answer || !unit) {
                showModal("Error: no se pudo obtener la información para guardar (faltan datos).");
                button.disabled = false;
                button.innerHTML = "Reintentar Guardar";
                return;
            }
            // --- FIN DEL FIX ---

            button.disabled = true;
            button.innerHTML = "Guardando...";

            try {
                const savedQuestionsRef = collection(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions');
                
                await addDoc(savedQuestionsRef, {
                    unit: unit, // NUEVO: Guardar la unidad
                    topic: topic,
                    question: question,
                    answer: answer, // Se guarda la respuesta HTML
                    createdAt: serverTimestamp(),
                    reviewStep: 0,
                    nextReviewDate: serverTimestamp()
                });

                button.innerHTML = "¡Guardado!";
                answerTextEl.contentEditable = false; // Bloquear edición después de guardar
                
                // NUEVO: Recalcular progreso después de guardar
                loadUnitsReview();

            } catch (error) {
                console.error("Error al guardar Q&A:", error);
                showModal(`No se pudo guardar la pregunta: ${error.message}`);
                button.disabled = false;
                button.innerHTML = "Reintentar Guardar";
            }
        }

        function setupSavedQuestionsListener() {
            if (savedQuestionsUnsubscribe) {
                savedQuestionsUnsubscribe(); 
            }
            if (!userId || !currentSubject) {
                clearReviewUI();
                return;
            }

            reviewLoader.style.display = 'block';
            reviewOutput.innerHTML = '';

            const now = new Date();
            const q = query(
                collection(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions'),
                where("nextReviewDate", "<=", now)
            );
            
            savedQuestionsUnsubscribe = onSnapshot(q, (snapshot) => {
                reviewLoader.style.display = 'none';
                
                const dueDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                dueDocs.sort((a, b) => (a.nextReviewDate?.toMillis() || 0) - (b.nextReviewDate?.toMillis() || 0));
                
                // El conteo de futuras se hace en el listener de 'Hoja de Ruta'
                // Aquí solo mostramos las que están 'due'
                reviewDueCount.textContent = dueDocs.length;

                if (dueDocs.length === 0) {
                    reviewOutput.innerHTML = '<p class="text-gray-500">¡Todo repasado por hoy! Vuelve más tarde.</p>';
                    return;
                }
                
                const groupedByTopic = dueDocs.reduce((acc, doc) => {
                    const topic = doc.topic || 'Sin Tema';
                    if (!acc[topic]) {
                        acc[topic] = [];
                    }
                    acc[topic].push(doc); 
                    return acc; 
                }, {}); 

                renderSavedQuestions(groupedByTopic);

            }, (error) => { 
                console.error("Error en listener de 'Repasar':", error);
                reviewLoader.style.display = 'none';
                reviewOutput.innerHTML = '<p class="text-red-500">Error al cargar las preguntas guardadas.</p>';
             });
         }

        // --- NUEVO: Función para renderizar Pestaña "Repasar (Hoy)" ---
        function renderSavedQuestions(groupedByTopic) {
            reviewOutput.innerHTML = '';
            
            const sortedTopics = Object.keys(groupedByTopic).sort();

            for (const topic of sortedTopics) {
                const topicGroupEl = document.createElement('div');
                topicGroupEl.className = 'topic-group';

                const topicButton = document.createElement('button');
                topicButton.className = 'topic-toggle-btn';
                topicButton.setAttribute('aria-expanded', 'false');
                topicButton.innerHTML = `
                    <span>${topic} (${groupedByTopic[topic].length})</span>
                    <span class="toggle-icon" data-lucide="chevron-down"></span>
                `;
                
                const questionsContainer = document.createElement('div');
                questionsContainer.className = 'topic-questions-container';

                groupedByTopic[topic].forEach(doc => {
                    // Usamos la nueva función helper
                    const card = createQACard(doc, true); // true = incluir controles de rating
                    questionsContainer.appendChild(card);
                });

                topicGroupEl.appendChild(topicButton);
                topicGroupEl.appendChild(questionsContainer);
                reviewOutput.appendChild(topicGroupEl);
            }
            if (typeof lucide !== 'undefined') { lucide.createIcons(); } // Actualizar íconos
        }

        // --- NUEVO: Helper para crear tarjetas de Q&A ---
        function createQACard(doc, includeRating) {
            const card = document.createElement('div');
            card.className = 'qa-card';
            card.dataset.id = doc.id;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-qa-btn';
            deleteBtn.dataset.id = doc.id;
            deleteBtn.innerHTML = '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.502 0c-.34.052-.68.107-1.022.166m11.48 0c.342.052.682.107 1.022.166m-5.462 0a48.108 48.108 0 00-3.478-.397m-1.246 0A48.258 48.258 0 0012 3c-1.37 0-2.714.098-4.022.282m0 0C7.644 3.37 6.64 3.655 5.752 4.043" /></svg>';
            
            const questionP = document.createElement('p');
            questionP.className = 'question';
            // --- FIX: Manejar preguntas corruptas ---
            questionP.textContent = doc.question || 'Pregunta no encontrada';
            
            const answerP = document.createElement('p');
            answerP.className = 'answer';
            // --- FIX: Convertir markdown y manejar respuestas corruptas ---
            answerP.innerHTML = convertMarkdownToHTML(doc.answer) || 'Respuesta no encontrada';
            
            card.appendChild(deleteBtn);
            card.appendChild(questionP);
            card.appendChild(answerP); 

            if (includeRating) {
                const showAnswerBtn = document.createElement('button');
                showAnswerBtn.className = 'show-answer-btn';
                showAnswerBtn.textContent = 'Mostrar Respuesta';
                
                const ratingControls = document.createElement('div');
                ratingControls.className = 'rating-controls';
                ratingControls.innerHTML = `
                    <button class="rate-btn" data-rating="hard" data-step="${doc.reviewStep || 0}" data-id="${doc.id}">Difícil</button>
                    <button class="rate-btn" data-rating="good" data-step="${doc.reviewStep || 0}" data-id="${doc.id}">Bien</button>
                    <button class="rate-btn" data-rating="easy" data-step="${doc.reviewStep || 0}" data-id="${doc.id}">Fácil</button>
                `;
                card.appendChild(ratingControls);
                card.appendChild(showAnswerBtn); 
            }

            return card;
        }

        // --- INICIO: Función de Acordeón MODIFICADA ---
        /**
         * NUEVO: Manejador genérico para todos los acordeones
         * @param {HTMLElement} button - El botón que fue clickeado
         * @param {string} [answerSelector] - Selector opcional para buscar la respuesta (para Q&A)
         */
        function handleAccordionToggle(button, answerSelector = null) {
            const isExpanded = button.getAttribute('aria-expanded') === 'true';
            
            // Determinar qué contenedor abrir/cerrar
            const container = answerSelector 
                ? button.closest('.qa-wrapper-units').querySelector(answerSelector)
                : button.nextElementSibling;
            
            if (!container) return;
            
            const icon = button.querySelector('.toggle-icon'); // Puede ser null para preguntas

            if (isExpanded) {
                button.setAttribute('aria-expanded', 'false');
                container.classList.remove('open');
                if (icon) icon.dataset.lucide = 'chevron-down';
                // Específico para Q&A en "Repaso por Unidades"
                if (answerSelector) container.style.display = 'none';
            } else {
                button.setAttribute('aria-expanded', 'true');
                container.classList.add('open');
                if (icon) icon.dataset.lucide = 'chevron-up';
                // Específico para Q&A en "Repaso por Unidades"
                if (answerSelector) container.style.display = 'block';
            }
            if(icon && typeof lucide !== 'undefined') { lucide.createIcons(); } // Refrescar el ícono
        }
        // --- FIN: Función de Acordeón MODIFICADA ---

        async function handleDeleteClick(button) {
            const id = button.dataset.id;
            if (!id) return;
            
            // --- FIX: Eliminado confirm() ---
            button.disabled = true;
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions', id);
                await deleteDoc(docRef);
                // La tarjeta se borrará automáticamente gracias a onSnapshot o recarga de pestaña
            } catch (error) {
                console.error("Error al borrar Q&A:", error);
                showModal(`No se pudo borrar la pregunta: ${error.message}`);
                button.disabled = false;
            }
        }

        function handleShowAnswerClick(button) {
            const card = button.closest('.qa-card');
            if (!card) return;

            card.querySelector('.answer').style.display = 'block';
            card.querySelector('.rating-controls').style.display = 'grid';
            button.style.display = 'none';
        }

        function getNextReview(currentStep, rating) {
            const intervals = [1, 3, 7, 15, 30, 60, 120]; 
            let nextStep;

            if (rating === 'hard') {
                nextStep = 0;
            } else if (rating === 'good') {
                nextStep = currentStep + 1;
            } else { // easy
                nextStep = currentStep + 2;
            }

            const now = new Date();
            let nextReviewDate = new Date();

            if (nextStep === 0) {
                nextReviewDate.setMinutes(now.getMinutes() + 10);
            } else {
                const daysToAdd = intervals[Math.min(nextStep - 1, intervals.length - 1)];
                nextReviewDate.setDate(now.getDate() + daysToAdd);
            }

            return { nextStep, nextReviewDate };
        }

        async function handleRateClick(button) {
            const id = button.dataset.id;
            const rating = button.dataset.rating;
            const currentStep = parseInt(button.dataset.step) || 0;
            const card = button.closest('.qa-card');

            if (!id || !rating) return;
            
            card.style.opacity = '0.5';

            try {
                const { nextStep, nextReviewDate } = getNextReview(currentStep, rating);
                
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions', id);
                await updateDoc(docRef, {
                    reviewStep: nextStep,
                    nextReviewDate: nextReviewDate
                });
                // onSnapshot se encargará de remover la tarjeta de la UI
                
                // NUEVO: Recalcular progreso después de calificar
                loadUnitsReview();

            } catch (error) {
                console.error("Error al actualizar la tarjeta de repaso:", error);
                showModal(`Error al guardar tu progreso: ${error.message}`);
                card.style.opacity = '1';
            }
        }

        // --- INICIO: NUEVAS funciones para Edición ---
        async function handleEditClick(button) {
            const id = button.dataset.id;
            if (!id) return;

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions', id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    editQaDocId.value = id;
                    editQaUnit.value = data.unit || 'Unidad General';
                    editQaTopic.value = data.topic || 'Sin Tema';
                    editQaQuestion.value = data.question || '';
                    editQaAnswer.value = data.answer || ''; // Esto es HTML, se edita como texto
                    
                    editQaModal.style.display = 'flex';
                } else {
                    showModal("Error: No se pudo encontrar la pregunta para editar.");
                }
            } catch (error) {
                console.error("Error al cargar pregunta para editar:", error);
                showModal(`Error al cargar: ${error.message}`);
            }
        }

        async function handleSaveChanges() {
            const id = editQaDocId.value;
            const newUnit = editQaUnit.value.trim() || 'Unidad General';
            const newTopic = editQaTopic.value.trim() || 'Sin Tema';
            const newQuestion = editQaQuestion.value.trim();
            const newAnswer = editQaAnswer.value; // El usuario edita el HTML (o texto plano)

            if (!id || !newQuestion || !newAnswer) {
                showModal("Error: La pregunta y la respuesta no pueden estar vacías.");
                return;
            }

            saveEditQaBtn.disabled = true;
            saveEditQaBtn.textContent = 'Guardando...';

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions', id);
                await updateDoc(docRef, {
                    unit: newUnit,
                    topic: newTopic,
                    question: newQuestion,
                    answer: newAnswer
                });

                editQaModal.style.display = 'none';
                loadUnitsReview(); // Recargar la vista de unidades

            } catch (error) {
                console.error("Error al guardar cambios:", error);
                showModal(`Error al guardar: ${error.message}`);
            } finally {
                saveEditQaBtn.disabled = false;
                saveEditQaBtn.textContent = 'Guardar Cambios';
            }
        }
        // --- FIN: NUEVAS funciones para Edición ---


        // --- INICIO: Función MODIFICADA para "Repaso por Unidades" ---
        async function loadUnitsReview() {
            if (!userId || !currentSubject) {
                clearUnitsUI();
                return;
            }

            unitsLoader.style.display = 'block';
            unitsOutput.innerHTML = '';

            try {
                const q = query(collection(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions'));
                const querySnapshot = await getDocs(q);
                
                const docs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // --- INICIO: Nueva lógica para Progreso General ---
                const savedTopics = new Set(docs.map(doc => doc.topic || 'Sin Tema'));
                const uniqueSavedTopicsCount = savedTopics.size;

                const materials = await getAllMaterials();

                // --- FIX: Comprobación de 'materials' ---
                if (!materials) {
                    unitsOutput.innerHTML = '<p class="text-red-500">Error al cargar los materiales. No se puede calcular el progreso.</p>';
                    unitsLoader.style.display = 'none';
                    return; 
                }

                let totalTopicsCount = 0;
                if (materials.syllabus && materials.syllabus.trim().length > 0) {
                    // Estima el total de temas contando las líneas no vacías del plan de estudio
                    totalTopicsCount = materials.syllabus.split('\n').filter(line => line.trim().length > 0).length;
                }
                
                updateUnitsProgress(uniqueSavedTopicsCount, totalTopicsCount);
                // --- FIN: Nueva lógica para Progreso General ---


                if (docs.length === 0) {
                    unitsOutput.innerHTML = '<p class="text-gray-500">Aún no has guardado ninguna pregunta para esta materia.</p>';
                    unitsLoader.style.display = 'none';
                    return;
                }
                
                // Agrupar por Unidad, luego por Tema
                const groupedByUnit = docs.reduce((acc, doc) => {
                    const unit = doc.unit || 'Unidad General';
                    const topic = doc.topic || 'Sin Tema';
                    if (!acc[unit]) {
                        acc[unit] = {};
                    }
                    if (!acc[unit][topic]) {
                        acc[unit][topic] = [];
                    }
                    acc[unit][topic].push(doc);
                    return acc;
                }, {});

                // Renderizar
                unitsOutput.innerHTML = '';
                const sortedUnits = Object.keys(groupedByUnit).sort();

                for (const unit of sortedUnits) {
                    const unitGroupEl = document.createElement('div');
                    unitGroupEl.className = 'unit-group';
                    
                    // Botón de Unidad
                    const unitButton = document.createElement('button');
                    unitButton.className = 'unit-toggle-btn';
                    unitButton.setAttribute('aria-expanded', 'false');
                    unitButton.innerHTML = `
                        <span>${unit}</span>
                        <span class="toggle-icon" data-lucide="chevron-down"></span>
                    `;
                    unitGroupEl.appendChild(unitButton);

                    // Contenedor de Temas (oculto)
                    const unitTopicsContainer = document.createElement('div');
                    unitTopicsContainer.className = 'unit-topics-container';
                    unitGroupEl.appendChild(unitTopicsContainer);


                    const sortedTopics = Object.keys(groupedByUnit[unit]).sort();
                    for (const topic of sortedTopics) {
                        
                        // Botón de Tema
                        const topicButton = document.createElement('button');
                        topicButton.className = 'topic-toggle-btn topic-toggle-btn-units';
                        topicButton.setAttribute('aria-expanded', 'false');
                        topicButton.innerHTML = `
                            <span class="text-lg font-semibold">${topic} (${groupedByUnit[unit][topic].length})</span>
                            <span class="toggle-icon" data-lucide="chevron-down"></span>
                        `;
                        unitTopicsContainer.appendChild(topicButton); // Add to unit container

                        // Contenedor de Preguntas (oculto)
                        const topicQuestionsContainer = document.createElement('div');
                        topicQuestionsContainer.className = 'topic-questions-container';
                        unitTopicsContainer.appendChild(topicQuestionsContainer);


                        groupedByUnit[unit][topic].forEach(doc => {
                            // Wrapper para Q&A
                            const qaWrapper = document.createElement('div');
                            qaWrapper.className = 'qa-wrapper-units';

                            // Botón de Pregunta (usa .qa-card para estilos)
                            const questionButton = document.createElement('button');
                            questionButton.className = 'question-toggle-btn-units qa-card';
                            questionButton.setAttribute('aria-expanded', 'false');

                            const questionContent = document.createElement('div');
                            questionContent.className = 'question-content';

                            const questionText = document.createElement('span');
                            questionText.className = 'question-text question'; // Reusa estilo .question
                            questionText.textContent = doc.question || 'Pregunta no encontrada';
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'delete-qa-btn';
                            deleteBtn.dataset.id = doc.id;
                            deleteBtn.innerHTML = '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.502 0c-.34.052-.68.107-1.022.166m11.48 0c.342.052.682.107 1.022.166m-5.462 0a48.108 48.108 0 00-3.478-.397m-1.246 0A48.258 48.258 0 0012 3c-1.37 0-2.714.098-4.022.282m0 0C7.644 3.37 6.64 3.655 5.752 4.043" /></svg>';

                            // NUEVO: Botón de Editar
                            const editBtn = document.createElement('button');
                            editBtn.className = 'edit-qa-btn';
                            editBtn.dataset.id = doc.id;
                            editBtn.innerHTML = '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>';


                            questionContent.appendChild(questionText);
                            questionContent.appendChild(deleteBtn);
                            questionContent.appendChild(editBtn); // AÑADIR BOTÓN
                            questionButton.appendChild(questionContent);

                            // Contenedor de Respuesta (oculto)
                            const answerContainer = document.createElement('div');
                            answerContainer.className = 'answer-container-units'; // Estilo base, .open lo muestra
                            answerContainer.innerHTML = convertMarkdownToHTML(doc.answer) || 'Respuesta no encontrada';

                            qaWrapper.appendChild(questionButton);
                            qaWrapper.appendChild(answerContainer);
                            topicQuestionsContainer.appendChild(qaWrapper);
                        });
                    }
                    unitsOutput.appendChild(unitGroupEl);
                }
                
                if (typeof lucide !== 'undefined') { lucide.createIcons(); } // Crear todos los íconos del acordeón

            } catch (error) {
                console.error("Error en loadUnitsReview:", error);
                unitsOutput.innerHTML = `<p class="text-red-500">Error al cargar las preguntas guardadas: ${error.message}</p>`;
            } finally {
                unitsLoader.style.display = 'none';
            }
        }
        // --- FIN: Función MODIFICADA para "Repaso por Unidades" ---
        
        // --- NUEVO: Función para actualizar barra de progreso general ---
        function updateUnitsProgress(savedCount, totalCount) {
            if (totalCount <= 0) {
                // No mostrar la barra si no hay plan de estudio cargado
                unitsProgressContainer.style.display = 'none';
                return;
            }
            
            const percentage = Math.min(100, (savedCount / totalCount) * 100);
            
            unitsProgressText.textContent = `Progreso General: ${savedCount} de ~${totalCount} temas cubiertos (${Math.round(percentage)}%)`;
            unitsProgressBar.style.width = `${percentage}%`;
            unitsProgressContainer.style.display = 'block';
        }
        
        // --- NUEVO: Funciones para Pestaña "Hoja de ruta" ---
        function setupFutureQuestionsListener() {
            if (futureQuestionsUnsubscribe) {
                futureQuestionsUnsubscribe(); 
            }
            if (!userId || !currentSubject) {
                clearRoadmapUI();
                return;
            }

            roadmapLoader.style.display = 'block';
            roadmapOutput.innerHTML = '';

            const now = new Date();
            const q = query(
                collection(db, 'artifacts', appId, 'users', userId, 'subjects', currentSubject, 'saved_questions'),
                where("nextReviewDate", ">", now),
                orderBy("nextReviewDate", "asc") // Ordenar por fecha
            );
            
            futureQuestionsUnsubscribe = onSnapshot(q, (snapshot) => {
                roadmapLoader.style.display = 'none';
                
                const futureDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Actualizar contador en 'Repasar (Hoy)'
                reviewFutureCount.textContent = futureDocs.length;

                if (futureDocs.length === 0) {
                    roadmapOutput.innerHTML = '<p class="text-gray-500">No hay preguntas programadas para el futuro.</p>';
                    return;
                }

                renderFutureQuestions(futureDocs);

            }, (error) => { 
                console.error("Error en listener de 'Hoja de ruta':", error);
                roadmapLoader.style.display = 'none';
                roadmapOutput.innerHTML = '<p class="text-red-500">Error al cargar las preguntas futuras.</p>';
             });
        }

        function renderFutureQuestions(docs) {
            roadmapOutput.innerHTML = '';
            
            const groupedByDate = docs.reduce((acc, doc) => {
                const date = doc.nextReviewDate.toDate().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(doc);
                return acc;
            }, {});

            for (const date in groupedByDate) {
                const dateGroupEl = document.createElement('div');
                dateGroupEl.className = 'roadmap-date-group';

                const dateTitle = document.createElement('h3');
                dateTitle.className = 'roadmap-date-title';
                dateTitle.textContent = date;
                dateGroupEl.appendChild(dateTitle);

                groupedByDate[date].forEach(doc => {
                    const card = createQACard(doc, false); // Sin rating
                    dateGroupEl.appendChild(card);
                });

                roadmapOutput.appendChild(dateGroupEl);
            }
        }
        
        // --- Ranking ---
         async function handleGenerateRanking() {
            rankingLoader.style.display = 'block';
            generateRankingBtn.disabled = true;
            rankingOutput.innerHTML = "Analizando experiencias...";

            const materials = await getAllMaterials();
            if (!materials) {
                rankingLoader.style.display = 'none';
                generateRankingBtn.disabled = false;
                return;
            }

            const systemPrompt = "Eres un asistente de análisis de datos educativos. Tu trabajo es analizar transcripciones de experiencias de exámenes orales y encontrar patrones de frecuencia. IMPORTANTE: Para resaltar texto clave, usa el formato Markdown `**texto en negrita**`. No utilices ningún otro formato.";
            
            const userQuery = `
                Analiza las siguientes experiencias de exámenes orales:
                --- EXPERIENCIAS PASADAS ---
                ${materials.experiences}
                --- FIN EXPERIENCIAS ---
                --- PLAN DE ESTUDIO (para contexto de nombres de temas) ---
                ${materials.syllabus || "No proporcionado."}
                --- FIN PLAN DE ESTUDIO ---
                Tu tarea es identificar y generar un ranking de los temas preguntados con MÁS frecuencia.
                La lista debe ser clara, ordenada y concisa, del tema más frecuente al menos frecuente.
                Devuelve solo la lista ordenada.
            `;

            try {
                const result = await callGemini(systemPrompt, userQuery);
                rankingOutput.innerHTML = convertMarkdownToHTML(result); // Convertir
            } catch (error) {
                console.error("Error al generar ranking:", error);
                showModal(`Error al comunicarse con la IA: ${error.message}`);
                rankingOutput.innerHTML = "Ocurrió un error al generar el ranking.";
            } finally {
                rankingLoader.style.display = 'none';
                generateRankingBtn.disabled = false;
            }
        }
        
        // --- NUEVO: Función para manejar la carga de PDF ---
        async function handlePdfUpload(file, targetTextareaId) {
            const textarea = document.getElementById(targetTextareaId);
            const statusEl = document.querySelector(`[data-status-for="${targetTextareaId}"]`);

            if (!textarea || !statusEl) return;

            statusEl.textContent = 'Procesando PDF...';
            statusEl.style.color = '#2563eb'; // blue-600

            const fileReader = new FileReader();
            
            fileReader.onload = async function() {
                try {
                    const arrayBuffer = this.result;
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                    const pdf = await loadingTask.promise;
                    
                    let fullText = '';
                    
                    statusEl.textContent = `Procesando página 1 de ${pdf.numPages}...`;

                    for (let i = 1; i <= pdf.numPages; i++) {
                        if (i > 1) {
                             statusEl.textContent = `Procesando página ${i} de ${pdf.numPages}...`;
                        }
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        // Unir los 'str' de 'items' y añadir espacio
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n\n'; // Añadir saltos de línea entre páginas
                    }
                    
                    // Añadir al textarea
                    const separator = '\n\n--- PDF AÑADIDO ---\n\n';
                    textarea.value += (textarea.value.trim().length > 0 ? separator : '') + fullText;
                    
                    statusEl.textContent = `¡Éxito! Se añadieron ${pdf.numPages} páginas del archivo "${file.name}".`;
                    statusEl.style.color = '#059669'; // green-600
                    setTimeout(() => statusEl.textContent = '', 5000);

                } catch (error) {
                    console.error("Error al procesar PDF:", error);
                    statusEl.textContent = `Error al procesar "${file.name}". ¿Es un PDF de texto?`;
                    statusEl.style.color = '#dc2626'; // red-600
                }
            };

            fileReader.onerror = function() {
                statusEl.textContent = 'Error al leer el archivo.';
                statusEl.style.color = '#dc2626'; // red-600
            };
            
            fileReader.readAsArrayBuffer(file);
        }

        // --- INICIAR LA APLICACIÓN ---
        initializeFirebase();

        // --- LISTENERS DEL MODAL DE SINCRONIZACIÓN ---
        document.getElementById('save-sync-id').addEventListener('click', () => {
            const inputId = document.getElementById('sync-id-input').value.trim();
            if (inputId) {
                localStorage.setItem('my_sync_userId', inputId);
                window.location.reload(); // Recargar para aplicar el ID
            } else {
                showModal("Por favor, introduce un ID válido.");
            }
        });
        
        document.getElementById('generate-sync-id').addEventListener('click', () => {
            const newId = crypto.randomUUID(); // Genera un ID único
            localStorage.setItem('my_sync_userId', newId);
            window.location.reload(); // Recargar para aplicar el ID
        });

    </script>
</body>
</html>
